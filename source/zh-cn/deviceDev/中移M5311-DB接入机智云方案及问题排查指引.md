# 中移M5311-DB接入机智云方案及问题排查指引

## 修订历史

| 版本        | 修订内容    |  修订人  | 修订日期|
| :------:   | :-----:   | :----: |:----:|
| V1.0        |起稿      |   Bobo    |2020/06/04|


## 1.本文编写背景
本文主要介绍中国移动M5311-DB（下文简称中移M5311）如何快速从零开始接入机智云，实现简单的透传功能，以及常见的问题排查，还提供了该模组的相关资料。

## 2. 中移M5311模组资料下载及获取

中移M5311模组资料下载 ====》 [点击下载](https://gizwits-doc-1251025085.cos.ap-guangzhou.myqcloud.com/ModuleData/NB-Module/CM-M5311/M5311-ModuleData.zip)

中移M5311模组烧录工具下载 ====》 [点击下载](https://gizwits-doc-1251025085.cos.ap-guangzhou.myqcloud.com/ModuleData/NB-Module/CM-M5311/M5311-DownloadTools.rar)

## 3. 中移M5311外围设计原理图

请下载第2章内容，参考《M5311硬件参考设计_V1.5_0428》推荐的外围设计原理图。

## 4. 中移M5311串口烧写固件说明

### 4.1、中移M5311固件获取与确认
当拿到一片中移M5311的模块的时候，若确认固件未烧写，请联系商务同事或FAE同事获取。拿到之后解压固件压缩包。

解压之后，会得到多个文件，里面的.bin文件就是我们烧写所要的文件。

>备注：本文固件名称以中移M5311_04030002版本固件为例，其他版本的模组固件名称的软硬件版本名字会有差异。

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_1.png)


### 4.2、中移M5311硬件设备连接
中移M5311模块烧写需要按照手册正常接出电源，调试串口，开机引脚，具体详细的接线方法可以参考文章第2章内容，参考《M5311硬件设计手册_V1.7》文档。

#### 4.2.1、中移M5311 调试串口接线

模组提供了两个通用异步收发器：主串口和调试串口。主串口主要用于串口命令数据收发；调试串口主要用于更新模组程序和 log 打印，该部分我们使用调试串口进行烧录固件，需要将模组的1、2管脚接出

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_2.png)

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_3.png)

#### 4.2.2、中移M5311 电源参考电路

模块的电源设计尤为重要。M5311 可使用低静态电流、输出电流能力大于 0.5A 的 LDO 作为供电电源；
模块在数传工作中，必须确保电源在正常工作范围，否则模块会异常。
为保证 VBAT 电压不会有较大跌落，在靠近模组 VBAT 输入端，建议并联一个低 ESR (ESR=0.7Ω)的 100uF
以上的电容，以及 100nF、33pF（0603 封装）、10pF（0603 封装）滤波电容，VBAT 输入端参考电路如下图
所示。并且建议 VBAT 的 PCB 走线尽量短且足够宽，减小 VBAT 走线的等效阻抗，确保在最大发射功率时大电
流下不会产生太大的电压跌落。建议 VBAT 走线宽度不少于 2mm，并且走线越长，线宽越宽。

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_4.png)


#### 4.2.3、中移M5311 开机引脚设计

模组正常开机方式是通过 PWR_ON/OFF 引脚来开机。将 PWR_ON/OFF 置为低电平，保持 t1 为 1s 以上
即可开机，开机之后需要置高电平。

推荐使用开集驱动电路来控制 PWR_ON/OFF 引脚。下图为参考电路：

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_5.png)



### 4.3、中移M5311 确认串口参数

根据文章4.2.1，将上述串口通过TTL串口转换工具连接电脑后，再根据文章4.2.3章节，使模组开机。通过“我的电脑”->“管理”-> “设备管理器”->“端口（COM 和LPT）”选项中可以看到相应增加的COM口。

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_6.png)

### 4.4、中移M5311的烧写

1、当串口正常连接成功之后，从本文第2章节获取资料，获得烧录工具IOT_Flash_Tool。

2、解压打开之后双击<FlashTool.exe>应用程序文件，点击选择对应的COM口，点击open，选择固件文件夹下面的<flash_download.cfg>文件，再点击绿色的“Start”按键。

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_7.png)

3、点击“Start”之后，对模组进行上电，并且开机，软件便会进入烧录模式。

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_8.png)

4、稍等片刻后，会弹出烧写成功的提示，这时候固件就烧录完成了。

![中移M5311](/assets/zh-cn/deviceDev/M5311/M5311_9.png)

## 5、中移M5311模组日志抓取

### 5.1、中移M5311模组日志接线方法
按照中移M5311的管脚定义图，将图中所示的1管脚（芯片调试日志信息输出口）连接USB转TTL工具的RXD上，且USB转TTL工具的GND需接模组的GND，然后将USB转TTL工具连接到电脑，确认端口。

![Alt text](/assets/zh-cn/deviceDev/M5311/M5311_10.png)

- **通信串口：**

| 管脚号 | 管脚名 | 描述 |
| :-: | :-: | :-: |
| 9 | TXD | 主串口 发送数据 |
| 10 | RXD | 主串口 接收数据 |

- **日志串口：**

| 管脚号 | 管脚名 | 描述 |
| :-: | :-: | :-: |
| 1 | DBG_TXD | debug 串口发送数据 |
| 2 | DBG_RXD | debug 串口接收数据 |

- **主串口设计图：**

![Alt text](/assets/zh-cn/deviceDev/M5311/M5311_11.png)

- **调试串口设计图：**

![Alt text](/assets/zh-cn/deviceDev/M5311/M5311_12.png)


### 5.2、机智云串口打印软件工具的获取与使用

1. 按照文章5.1的管脚定义图，将图中所示的1管脚（DBG_TXD）（芯片调试日志信息输出口）通过USB转TTL工具连接到电脑，且USB转TTL工具的GND需接模组的GND，波特率115200bps。

2. 机智云串口打印软件工具下载链接：链接：https://eyun.baidu.com/s/3oAbSruq 密码：pPsL

3. 打开串口打印工具，选择对应的COM口与波特率，点击“打开串口”

![Alt text](/assets/zh-cn/deviceDev/M5311/M5311_13.png)

4. 然后对模组进行上电并开机，即正常输出模组GAgent的日志，查看版本号是否正确即可。

![Alt text](/assets/zh-cn/deviceDev/M5311/M5311_14.png)

## 6.搭配gokit接入机智云（包含创建数据点，下载代码，demoAPP扫码绑定及控制设备等等）
快速接入文档参考链接：http://docs.gizwits.com/zh-cn/deviceDev/debug/NB_Project.html

>备注：模组uart为与Gokit通讯的通讯串口，通讯波特率为9600bps，具体可参考文章5.1的模组接线方法图

## 7.FAQ
